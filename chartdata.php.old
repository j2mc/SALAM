<?php

/* 
detail.php for SALAM v2
By Jacob McEntire
Copyright 2018
*/

require("library/SSI.php");

if (isset($_GET['type']) && isset($_GET['id']) && isset($_GET['range'])) {
	$type = check_xss($_GET['type']);
	$id = check_xss($_GET['id']);
	$range = check_xss($_GET['range']);
	if ($range == 1) {
		$titlerange = "24 Hours";
		$checkdata_stmt = db_prepare("SELECT time, rtime FROM checkdata WHERE type = ? AND type_id = ? and time > ?");
		db_execute($checkdata_stmt, array($type, $id, time() - 86400));
		$checkdata = db_fetch($checkdata_stmt);
		if (!empty($checkdata)) {
			$jsdata = "[";
			foreach($checkdata as $d) {
				$jsdata .= '{ "t": ' . $d['time'] * 1000 . ', "y": ' . $d['rtime'] / 1000 . ' },';
			}
			$jsdata .= "]";
			echo '
			"type": "line",
			"data": {
				"dataset"s: [{
					"backgroundColor": "#eca9a7",
					"borderColor": "#d9534f",
					"borderWidth": 2,
					"pointRadius": 0,
					"pointHitRadius": 10,
					"data": ', $jsdata, '
				}]
			},';
		}
	}
	else {
		if ($range == 7) {
			$resolution = 0;
			$titlerange = "7 Days";
		}
		elseif ($range == 30) {
			$resolution = 1;
			$titlerange = "30 Days";
		}
		else {
			$resolution = 2;
			$titlerange = "Year";
		}
		$range *= 86400;
		$archivedata_stmt = db_prepare("SELECT time, min_rt, avg_rt, max_rt FROM archivedata WHERE type = ? AND type_id = ? AND time > ? AND resolution = ?");
		db_execute($archivedata_stmt, array($type, $id, time() - $range, $resolution));
		$archivedata = db_fetch($archivedata_stmt);
		if (!empty($archivedata)) {
			$mindata = "[";
			$avgdata = "[";
			$maxdata = "[";
			foreach($archivedata as $d) {
				$mindata .= "{ t: " . $d["time"] * 1000 . ", y: " . $d["min_rt"] / 1000 . " },";
				$avgdata .= "{ t: " . $d["time"] * 1000 . ", y: " . $d["avg_rt"] / 1000 . " },";
				$maxdata .= "{ t: " . $d["time"] * 1000 . ", y: " . $d["max_rt"] / 1000 . " },";
			}
			$mindata .= "]";
			$avgdata .= "]";
			$maxdata .= "]";
			echo '
			"type": "line",
			"data": {
				"datasets": [{
					"label": "Minimum",
					"backgroundColor": "#addbad",
					"borderColor": "#5cb85c",
					"borderWidth": 2,
					"pointRadius": 0,
					"data": $mindata,
					"fill": true,
				},{
					"label": "Average",
					"backgroundColor": "#a0c5e4",
					"borderColor": "#428bca",
					"borderWidth": 2,
					"pointRadius": 0,
					"data": $avgdata,
					"fill": true,
				},{
					"label": "Maximum",
					"backgroundColor": "#eca9a7",
					"borderColor": "#d9534f",
					"borderWidth": 2,
					"pointRadius": 0,
					"pointHitRadius": 10,
					"data": $maxdata,
					"fill": true,
				}]
			},';
		}
	}
	if (!empty($jsdata)) {
		echo '
			"options": {
				"title": {
					"display": true,
					"text": "Response Time Last "
				},
				"scales": {
					"xAxes": [{
						"type": "time",
						"display": true,
					}],
					"yAxes": [{
						"display": true,
						"scaleLabel": {
							"display": true,
							"labelString": "ms"
						},
						"ticks": {
							"suggestedMax": 10
						}
					}]
				},
				"legend": {
					"display": false
				},
				"elements": {
					"line": {
						"tension": 0
					}
				}
			}";
	}
}
?>